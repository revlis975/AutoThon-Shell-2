<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Test Plan Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<!-- Tabulator table -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tabulator-tables@5.6.0/dist/css/tabulator_midnight.min.css">
<script src="https://cdn.jsdelivr.net/npm/tabulator-tables@5.6.0/dist/js/tabulator.min.js"></script>

<!-- Chart.js for graphs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
  body { background:#1e1e2f; color:#e0e0e0; font-family:Segoe UI,Roboto,Arial,sans-serif; margin:0; }
  header { background:#2d2d44; padding:1rem 2rem; text-align:center; }
  h1 { margin:0; color:#90caf9; }
  section { padding:1rem 2rem; }
  canvas { max-width:100%; }
  #charts { display:flex; flex-wrap:wrap; gap:2rem; justify-content:space-around; }
  #plan-table { margin-top:2rem; }
</style>
</head>
<body>
<header>
  <h1>Test Plan Dashboard</h1>
</header>

<section id="charts">
  <div style="width:400px;">
    <h3>Incidents by Environment</h3>
    <canvas id="envChart"></canvas>
  </div>
  <div style="width:400px;">
    <h3>Incidents by Failure Type</h3>
    <canvas id="failChart"></canvas>
  </div>
  <div style="width:400px;">
    <h3>Average Final Minutes per Module</h3>
    <canvas id="moduleChart"></canvas>
  </div>
</section>

<section>
  <h2>Incident Table</h2>
  <div id="plan-table"></div>
</section>

<script>
fetch("plan.json")
  .then(r => r.json())
  .then(data => {
    // ---------- Tabulator Table ----------
    new Tabulator("#plan-table", {
      data:data,
      layout:"fitColumns",
      pagination:"local",
      paginationSize:15,
      height:"600px",
      columns:[
        {title:"Priority", field:"priority_score", sorter:"number", headerFilter:"input"},
        {title:"Module", field:"module", sorter:"string", headerFilter:"input"},
        {title:"Environment", field:"environment", sorter:"string", headerFilter:"input"},
        {title:"Failure Type", field:"failure_type", sorter:"string", headerFilter:"input"},
        {title:"Base Min", field:"Base_minutes", sorter:"number"},
        {title:"Final Min", field:"Final_minutes", sorter:"number"},
        {title:"Test ID", field:"test_id", width:260}
      ]
    });

    // ---------- Prepare chart data ----------
    const countBy = (arr, key) =>
      arr.reduce((acc,x)=>{acc[x[key]]=(acc[x[key]]||0)+1; return acc;}, {});
    const avgByModule = data.reduce((acc,x)=>{
      const m=x.module||"Unknown";
      if(!acc[m]) acc[m]={sum:0,cnt:0};
      acc[m].sum += x.Final_minutes;
      acc[m].cnt++;
      return acc;
    },{});
    const avgModuleData = Object.entries(avgByModule)
                                .map(([k,v])=>({module:k,avg:v.sum/v.cnt}))
                                .sort((a,b)=>b.avg-a.avg)
                                .slice(0,10); // top 10

    const envCounts = countBy(data,"environment");
    const failCounts = countBy(data,"failure_type");

    const palette = ['#4caf50','#2196f3','#ff9800','#e91e63','#9c27b0','#00bcd4','#ff5722','#8bc34a','#cddc39'];

    // ---------- Charts ----------
    new Chart(document.getElementById('envChart'), {
      type:'pie',
      data:{
        labels:Object.keys(envCounts),
        datasets:[{data:Object.values(envCounts),backgroundColor:palette}]
      },
      options:{plugins:{legend:{labels:{color:'#e0e0e0'}}}}
    });

    new Chart(document.getElementById('failChart'), {
      type:'doughnut',
      data:{
        labels:Object.keys(failCounts),
        datasets:[{data:Object.values(failCounts),backgroundColor:palette}]
      },
      options:{plugins:{legend:{labels:{color:'#e0e0e0'}}}}
    });

    new Chart(document.getElementById('moduleChart'), {
      type:'bar',
      data:{
        labels:avgModuleData.map(x=>x.module),
        datasets:[{label:'Avg Final Minutes',
                   data:avgModuleData.map(x=>x.avg),
                   backgroundColor:'#90caf9'}]
      },
      options:{
        scales:{
          x:{ticks:{color:'#e0e0e0'}},
          y:{ticks:{color:'#e0e0e0'}}
        },
        plugins:{legend:{display:false}}
      }
    });
});
</script>
</body>
</html>